<!--
========================================
Mangaroo - Reader Page (reader.html)
========================================

This is the main reading interface - the heart of the app!
It displays a split-screen with:
- LEFT: Novel text (scrollable)
- RIGHT: Generated manga panels (sticky)

KEY CONCEPTS:
- Split-screen layout using CSS Grid
- Async API calls to load pages and generate images
- Story Bible panel shows AI's understanding of the scene

USER FLOW:
1. Page loads → First page text is fetched
2. User reads text on left side
3. User clicks "Generate" → AI creates manga panel
4. User clicks "Next Page" → Next page text loads
5. Repeat!

KEYBOARD SHORTCUTS:
- ← : Previous page
- → : Next page
- G  : Generate manga panel
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title shows the book being read -->
    <title>{{ title }}</title>

    <!-- 
    ========================================
    FONTS & STYLES
    ========================================
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Tailwind config with our custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'webtoon': {
                            'green': '#60D071',
                            'green-hover': '#4DBE5E',
                        },
                        'manga': {
                            'dark': '#3C3C3C',
                            'light': '#F8F8F8',
                        }
                    },
                    fontFamily: {
                        'futura': ['Futura', 'Trebuchet MS', 'Arial', 'sans-serif'],
                        'inter': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- 
    ========================================
    READER-SPECIFIC STYLES
    ========================================
    These styles are only used on this page
    -->
    <style>
        /* Text content styling for readability */
        .prose-content {
            font-size: 1.125rem;
            line-height: 1.875;
            /* Extra line height for easy reading */
            white-space: pre-wrap;
            /* Preserve formatting */
            word-wrap: break-word;
        }

        /* Paragraph indentation (like a real book) */
        .prose-content p {
            margin-bottom: 1.25rem;
            text-indent: 1.5rem;
            /* Indent first line */
        }

        /* Don't indent the very first paragraph */
        .prose-content p:first-child {
            text-indent: 0;
        }

        /* Frame around manga images */
        .manga-frame {
            background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 3px solid #2a2a2a;
            border-radius: 8px;
            padding: 8px;
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        /* Shimmer animation for loading state */
        .generating-animation {
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(96, 208, 113, 0.1) 50%,
                    transparent 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Page turn animation */
        .page-turn-animation {
            animation: pageTurn 0.4s ease-out;
        }

        @keyframes pageTurn {
            0% {
                opacity: 0;
                transform: translateX(20px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>

<!-- overflow-hidden prevents the whole page from scrolling -->

<body class="bg-white font-inter overflow-hidden">

    <!-- 
    ========================================
    READER CONTAINER (Split Screen)
    ========================================
    Uses CSS Grid to create two equal columns
    -->
    <div class="reader-container">

        <!-- 
        ========================================
        LEFT PANEL - NOVEL TEXT
        ========================================
        This is where the story text appears
        -->
        <div class="text-panel">

            <!-- 
            HEADER BAR
            Shows book info and navigation
            -->
            <div class="text-panel-header">
                <div class="flex items-center gap-3">
                    <!-- Back to home button -->
                    <a href="/" class="text-gray-400 hover:text-webtoon-green transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <!-- Book title and author -->
                    <div>
                        <!-- 
                        {{ filename }} is a Jinja2 variable
                        It's set in main.py when rendering this template
                        -->
                        <h2 class="font-semibold text-manga-dark text-sm">{{ filename }}</h2>
                        <p class="text-xs text-gray-500">{{ metadata.get('author', 'Unknown Author') }}</p>
                    </div>
                </div>
                <!-- Story Bible toggle button -->
                <div class="flex items-center gap-2">
                    <button id="storyBibleToggle" class="p-2 text-gray-400 hover:text-webtoon-green transition-colors"
                        title="Story Bible">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- 
            TEXT CONTENT AREA
            This is where the actual story text goes
            Scrollable when content is long
            -->
            <div class="text-content" id="textContent">
                <!-- Text gets inserted here by JavaScript -->
                <div id="textDisplay" class="prose-content">
                    <p class="text-gray-400 text-center">Loading page content...</p>
                </div>

                <!-- 
                STORY BIBLE PANEL
                Shows AI's understanding of the current scene
                Hidden by default, toggled with button
                -->
                <div id="storyBiblePanel" class="story-bible-panel hidden mt-8">
                    <h4>
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Story Context
                    </h4>
                    <div id="storyBibleContent" class="story-bible-content">
                        <p>No context generated yet.</p>
                    </div>
                </div>
            </div>

            <!-- 
            NAVIGATION CONTROLS
            Previous/Next buttons and page indicator
            -->
            <div class="nav-controls">
                <!-- Previous button -->
                <button id="prevBtn" class="btn btn-outline" disabled>
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Previous
                </button>

                <!-- Page indicator: "Page X of Y" -->
                <div class="page-indicator">
                    Page <span id="currentPage">1</span> of <span id="totalPages">{{ total_pages }}</span>
                </div>

                <!-- 
                NEXT PAGE BUTTON
                Green (#60D071) with rounded corners per design spec
                -->
                <button id="nextBtn" class="btn btn-primary">
                    Next Page
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 
        ========================================
        RIGHT PANEL - MANGA DISPLAY
        ========================================
        Shows generated manga images
        Sticky position keeps it visible while scrolling
        -->
        <div class="manga-panel">

            <!-- HEADER with title and generate button -->
            <div class="manga-panel-header">
                <h3 class="font-semibold text-sm flex items-center gap-2">
                    <svg class="w-5 h-5 text-webtoon-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Manga Panel
                </h3>
                <!-- Generate button - triggers AI image generation -->
                <button id="generateBtn" class="btn btn-primary text-sm py-1 px-3">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Generate
                </button>
            </div>

            <!-- 
            MANGA DISPLAY AREA
            Contains three states:
            1. Placeholder (before generation)
            2. Loading (during generation)
            3. Image (after generation)
            -->
            <div class="manga-display" id="mangaDisplay">

                <!-- 
                PLACEHOLDER STATE
                Shown when no image has been generated yet
                -->
                <div class="manga-placeholder" id="mangaPlaceholder">
                    <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Dashed rectangle representing empty panel -->
                        <rect x="10" y="10" width="100" height="100" rx="8" stroke="currentColor" stroke-width="2"
                            stroke-dasharray="6 4" />
                        <!-- Simple landscape shapes -->
                        <path d="M35 75L50 55L65 70L80 50L95 75" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <!-- Sun circle -->
                        <circle cx="45" cy="40" r="8" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <p class="text-lg font-medium">No panel generated yet</p>
                    <p class="text-sm mt-2">Click "Generate" to create a manga panel<br>for the current page</p>
                </div>

                <!-- 
                IMAGE CONTAINER
                Shows the actual generated manga image
                Hidden until image is ready
                -->
                <div id="mangaImageContainer" class="hidden manga-frame">
                    <img id="mangaImage" src="" alt="Generated manga panel" class="rounded">
                </div>

                <!-- 
                LOADING STATE
                Shown while AI is generating the image
                -->
                <div id="mangaLoading" class="hidden text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-300 font-medium">Generating manga panel...</p>
                    <p class="text-gray-500 text-sm mt-2">AI is analyzing the scene</p>
                    <!-- Progress bar with shimmer animation -->
                    <div class="w-64 h-2 bg-gray-700 rounded-full mt-4 overflow-hidden">
                        <div class="h-full bg-webtoon-green generating-animation rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- 
            PROMPT DISPLAY
            Shows what prompt was sent to the AI
            Useful for debugging/understanding
            -->
            <div id="promptDisplay" class="hidden px-4 pb-4">
                <div class="bg-black/30 rounded-lg p-3 text-xs text-gray-400">
                    <p class="font-medium text-gray-300 mb-1">Prompt used:</p>
                    <p id="promptText" class="italic"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 
    ========================================
    TOAST NOTIFICATION
    ========================================
    Small popup message for feedback
    (e.g., "Panel generated successfully!")
    -->
    <div id="toast"
        class="fixed bottom-4 right-4 bg-manga-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50">
        <p id="toastMessage"></p>
    </div>

    <!-- 
    ========================================
    JAVASCRIPT
    ========================================
    Handles all the interactivity
    -->
    <script>
        // ========================================
        // SESSION DATA FROM SERVER
        // ========================================
        // These values come from Jinja2 template variables
        // They're set in main.py when rendering this page
        const sessionId = '{{ session_id }}';    // Unique ID for this reading session
        const totalPages = {{ total_pages }};    // How many pages in the PDF

        // Track current state
        let currentPage = 0;        // Which page we're on (0-indexed)
        let isGenerating = false;   // Prevent multiple simultaneous generations

        // ========================================
        // DOM ELEMENT REFERENCES
        // ========================================
        const textDisplay = document.getElementById('textDisplay');
        const currentPageSpan = document.getElementById('currentPage');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const generateBtn = document.getElementById('generateBtn');
        const mangaPlaceholder = document.getElementById('mangaPlaceholder');
        const mangaImageContainer = document.getElementById('mangaImageContainer');
        const mangaImage = document.getElementById('mangaImage');
        const mangaLoading = document.getElementById('mangaLoading');
        const storyBibleToggle = document.getElementById('storyBibleToggle');
        const storyBiblePanel = document.getElementById('storyBiblePanel');
        const storyBibleContent = document.getElementById('storyBibleContent');
        const promptDisplay = document.getElementById('promptDisplay');
        const promptText = document.getElementById('promptText');

        // ========================================
        // TOAST NOTIFICATION
        // ========================================

        /**
         * Show a toast notification message
         * @param {string} message - The message to display
         * @param {number} duration - How long to show it (ms)
         */
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            // Set message and show toast
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-full', 'opacity-0');

            // Hide after duration
            setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
            }, duration);
        }

        // ========================================
        // PAGE TEXT LOADING
        // ========================================

        /**
         * Load text content for a specific page
         * Called when navigating between pages
         * @param {number} page - Page number to load (0-indexed)
         */
        async function loadPageText(page) {
            try {
                // Fetch page text from API
                const response = await fetch(`/api/get_page_text?session_id=${sessionId}&page=${page}`);
                const data = await response.json();

                if (data.success) {
                    // Format text into paragraphs
                    // Split on double newlines (paragraph breaks)
                    const paragraphs = data.text.split('\n\n').filter(p => p.trim());
                    const formattedText = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');

                    // Insert text with fallback for empty pages
                    textDisplay.innerHTML = formattedText || '<p class="text-gray-400 text-center">This page appears to be empty.</p>';

                    // Add page turn animation
                    textDisplay.classList.add('page-turn-animation');
                    setTimeout(() => {
                        textDisplay.classList.remove('page-turn-animation');
                    }, 400);

                    // Update state
                    currentPage = page;
                    currentPageSpan.textContent = page + 1;  // Display as 1-indexed

                    // Update navigation buttons
                    prevBtn.disabled = !data.has_prev;
                    nextBtn.disabled = !data.has_next;

                    // Scroll text panel to top
                    document.getElementById('textContent').scrollTop = 0;

                    // Reset manga panel for new page
                    resetMangaPanel();
                } else {
                    showToast('Error loading page');
                }
            } catch (error) {
                console.error('Error loading page:', error);
                showToast('Error loading page');
            }
        }

        // ========================================
        // MANGA PANEL MANAGEMENT
        // ========================================

        /**
         * Reset manga panel to initial state
         * Called when navigating to a new page
         */
        function resetMangaPanel() {
            mangaPlaceholder.classList.remove('hidden');
            mangaImageContainer.classList.add('hidden');
            mangaLoading.classList.add('hidden');
            promptDisplay.classList.add('hidden');
        }

        /**
         * Generate a manga panel for the current page
         * This calls the AI to create an image!
         */
        async function generatePanel() {
            // Prevent multiple simultaneous generations
            if (isGenerating) return;

            isGenerating = true;
            generateBtn.disabled = true;

            // Show loading state
            mangaPlaceholder.classList.add('hidden');
            mangaImageContainer.classList.add('hidden');
            mangaLoading.classList.remove('hidden');

            try {
                // Prepare form data for the API
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('page', currentPage);

                // Call the generate API
                const response = await fetch('/api/generate_panel', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.image_data) {
                    // SUCCESS! Display the generated image
                    // image_data is base64 encoded, so we create a data URL
                    mangaImage.src = `data:image/png;base64,${data.image_data}`;
                    mangaLoading.classList.add('hidden');
                    mangaImageContainer.classList.remove('hidden');

                    // Show the prompt that was used
                    if (data.prompt_used) {
                        promptText.textContent = data.prompt_used;
                        promptDisplay.classList.remove('hidden');
                    }

                    // Update story bible display
                    if (data.story_state) {
                        updateStoryBibleDisplay(data.story_state);
                    }

                    showToast('Panel generated successfully!');
                } else {
                    // Generation failed - show error
                    mangaLoading.classList.add('hidden');
                    mangaPlaceholder.classList.remove('hidden');

                    const errorMsg = data.error || 'Failed to generate panel';
                    showToast(errorMsg);

                    // Still update story bible if we got state back
                    if (data.story_state) {
                        updateStoryBibleDisplay(data.story_state);
                    }
                }
            } catch (error) {
                console.error('Error generating panel:', error);
                mangaLoading.classList.add('hidden');
                mangaPlaceholder.classList.remove('hidden');
                showToast('Error generating panel');
            } finally {
                // Re-enable generation regardless of outcome
                isGenerating = false;
                generateBtn.disabled = false;
            }
        }

        // ========================================
        // STORY BIBLE DISPLAY
        // ========================================

        /**
         * Update the Story Bible panel with current state
         * @param {Object} state - Story state from the API
         */
        function updateStoryBibleDisplay(state) {
            let html = '';

            // Current scene
            if (state.current_scene) {
                html += `<p class="mb-2"><strong>Scene:</strong> ${state.current_scene}</p>`;
            }

            // Characters (as tags)
            if (state.characters && state.characters.length > 0) {
                html += '<div class="mb-2"><strong>Characters:</strong> ';
                state.characters.forEach(char => {
                    const name = typeof char === 'string' ? char : char.name || 'Unknown';
                    html += `<span class="character-tag">${name}</span>`;
                });
                html += '</div>';
            }

            // Mood
            if (state.mood) {
                html += `<p class="mb-2"><strong>Mood:</strong> ${state.mood}</p>`;
            }

            // Location
            if (state.location_details) {
                html += `<p class="mb-2"><strong>Location:</strong> ${state.location_details}</p>`;
            }

            // Visual style
            if (state.visual_style) {
                html += `<p><strong>Style:</strong> ${state.visual_style}</p>`;
            }

            storyBibleContent.innerHTML = html || '<p>No context available.</p>';
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Previous page button
        prevBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                loadPageText(currentPage - 1);
            }
        });

        // Next page button
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages - 1) {
                loadPageText(currentPage + 1);
            }
        });

        // Generate button
        generateBtn.addEventListener('click', generatePanel);

        // Story Bible toggle
        storyBibleToggle.addEventListener('click', () => {
            storyBiblePanel.classList.toggle('hidden');
            storyBibleToggle.classList.toggle('text-webtoon-green');
        });

        // ========================================
        // KEYBOARD NAVIGATION
        // ========================================
        // Shortcuts:
        // - Arrow Left or A: Previous page
        // - Arrow Right or D: Next page
        // - G or W: Generate manga panel
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // Left arrow or A → Previous page
            if ((e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') && !prevBtn.disabled) {
                loadPageText(currentPage - 1);
            }
            // Right arrow or D → Next page
            else if ((e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') && !nextBtn.disabled) {
                loadPageText(currentPage + 1);
            }
            // G or W key → Generate panel
            else if ((e.key === 'g' || e.key === 'G' || e.key === 'w' || e.key === 'W') && !isGenerating) {
                generatePanel();
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================
        // Load the first page when the page opens
        loadPageText(0);
    </script>
</body>

</html>